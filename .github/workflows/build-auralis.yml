name: Build Auralis OS - Void Linux + Clear Linux Optimizations
on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'ultimate'
        type: choice
        options:
        - ultimate
        - fallback
      enable_debug:
        description: 'Enable Debug Logging'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]
    paths:
      - 'build-auralis.sh'
      - '.github/workflows/build-auralis.yml'
  pull_request:
    branches: [ main ]

env:
  AURALIS_VERSION: "1.0.0-beta"
  AURALIS_CODENAME: "Borealis"
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'ultimate' }}
  DEBUG_MODE: ${{ github.event.inputs.enable_debug || 'false' }}

jobs:
  build-auralis-void-clear:
    runs-on: ubuntu-latest
    timeout-minutes: 420  # 7 hours max for Void + Clear Linux optimized build
    
    strategy:
      fail-fast: false
      
    steps:
    - name: ðŸš€ Checkout Auralis OS Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: ðŸŽ¯ Display Build Information
      run: |
        echo "ðŸ”¥ AURALIS OS - VOID LINUX + CLEAR LINUX OPTIMIZATIONS"
        echo "======================================================"
        echo "ðŸ“‹ Build Configuration:"
        echo "  ðŸ·ï¸ Version: $AURALIS_VERSION ($AURALIS_CODENAME)"
        echo "  ðŸŽ® Build Type: $BUILD_TYPE"
        echo "  ðŸ› Debug Mode: $DEBUG_MODE"
        echo "  ðŸ“… Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "  ðŸŒ Platform: GitHub Actions (Sequential)"
        echo "  ðŸ’ª Runner: ubuntu-latest"
        echo ""
        echo "ðŸŽ¯ System Architecture:"
        echo "  ðŸ“¦ Base System: Void Linux (XBPS, runit, musl/glibc)"
        echo "  âš¡ Performance: Clear Linux inspired optimizations"
        echo "  ðŸ”¥ Kernel: linux-zen + PREEMPT_RT + 2000 Hz + CONFIG_NO_HZ_IDLE"
        echo "  ðŸ’» Target: Intel CPU optimized"
        echo "  ðŸ§  Strategy: Sequential Resource Management"
        echo ""
        
    - name: ðŸ–¥ï¸ Show GitHub Actions Resources
      run: |
        echo "ðŸ–¥ï¸ GitHub Actions Build Resources:"
        echo "  ðŸ’» CPU Info: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs)"
        echo "  ðŸ§  CPU Cores: $(nproc)"
        echo "  ðŸ§  RAM Total: $(free -h | grep '^Mem:' | awk '{print $2}')"
        echo "  ðŸ§  RAM Available: $(free -h | grep '^Mem:' | awk '{print $7}')"
        echo "  ðŸ’¾ Disk Space: $(df -h / | tail -1 | awk '{print $4}') available"
        echo "  ðŸ“Š Load Average: $(uptime | awk -F'load average:' '{print $2}')"
        echo "  ðŸ”§ Build Strategy: Sequential (Kernel â†’ Cleanup â†’ Void System)"
        echo ""
        
    - name: ðŸ§¹ Maximum Disk Space Cleanup
      run: |
        echo "ðŸ§¹ Performing MAXIMUM disk space cleanup for Void + Clear Linux build..."
        
        # Show initial space
        echo "ðŸ“Š Initial disk usage:"
        df -h /
        
        # Remove large unnecessary directories
        echo "ðŸ—‘ï¸ Removing unnecessary directories..."
        sudo rm -rf /usr/local/lib/android /opt/ghc /usr/local/.ghcup 2>/dev/null || true
        sudo rm -rf /usr/share/dotnet /opt/az /usr/local/share/boost 2>/dev/null || true
        sudo rm -rf /usr/local/lib/node_modules /opt/hostedtoolcache 2>/dev/null || true
        sudo rm -rf /usr/share/swift /usr/local/julia* 2>/dev/null || true
        
        # Clean package caches
        echo "ðŸ§½ Cleaning package caches..."
        sudo apt-get clean
        sudo apt-get autoremove -y
        
        # Clean Docker
        echo "ðŸ³ Cleaning Docker system..."
        docker system prune -af 2>/dev/null || true
        
        # Clean snap packages
        echo "ðŸ“¦ Cleaning snap packages..."
        sudo snap list 2>/dev/null | awk 'NR>1{print $1}' | xargs -r sudo snap remove 2>/dev/null || true
        
        # Force filesystem cleanup
        echo "ðŸ’¾ Force filesystem cleanup..."
        sync
        sudo fstrim -av 2>/dev/null || true
        
        # Show final space
        echo "ðŸ“Š Final disk usage after cleanup:"
        df -h /
        
        echo "âœ… Disk space cleanup completed!"
        echo "ðŸŽ¯ Ready for Void Linux + Clear Linux optimized build!"
        
    - name: âš¡ Install Build Dependencies for Void + Clear Linux
      run: |
        echo "âš¡ Installing build dependencies for Void + Clear Linux optimizations..."
        
        # Update package lists
        sudo apt-get update
        
        # Core build tools
        sudo apt-get install -y \
          build-essential git wget curl tar rsync \
          flex bison bc gawk perl python3 cpio time pv
        
        # Kernel build dependencies
        sudo apt-get install -y \
          libssl-dev libelf-dev libncurses-dev \
          dwarves pahole kmod
        
        # ISO creation tools
        sudo apt-get install -y \
          squashfs-tools genisoimage xorriso \
          debootstrap xz-utils
        
        # Clear Linux inspired performance tools
        sudo apt-get install -y \
          clang lld llvm \
          ccache \
          elfutils binutils-dev \
          schedtool \
          numactl
        
        # RT patch tools
        sudo apt-get install -y \
          quilt patch \
          libaudit-dev \
          libnuma-dev
        
        echo "âœ… Build dependencies for Void + Clear Linux optimizations installed!"
        
    - name: ðŸ”§ Setup ccache for Clear Linux Style Optimizations
      run: |
        echo "ðŸ”§ Setting up ccache with Clear Linux style optimizations..."
        
        # Configure ccache for maximum performance
        export CCACHE_DIR="/tmp/ccache"
        mkdir -p "$CCACHE_DIR"
        
        # Set aggressive ccache settings for Clear Linux style builds
        ccache -M 4G
        ccache --set-config=compression=true
        ccache --set-config=compression_level=6
        ccache --set-config=max_files=10000
        ccache --set-config=sloppiness=file_macro,locale,time_macros
        
        # Show ccache configuration
        echo "ðŸ“Š ccache configuration:"
        ccache --show-config | head -20
        
        # Add ccache to PATH
        echo "/usr/lib/ccache" >> $GITHUB_PATH
        
        echo "âœ… ccache configured for Clear Linux style optimizations!"
        
    - name: ðŸ—ï¸ Verify Void + Clear Linux Build Script
      run: |
        echo "ðŸ—ï¸ Preparing Void Linux + Clear Linux optimized build script..."
        chmod +x build-auralis.sh
        
        # Verify script contains Void Linux and Clear Linux references
        echo "ðŸ“‹ Build script verification:"
        echo "  ðŸ“„ File size: $(du -h build-auralis.sh | cut -f1)"
        echo "  ðŸ“ Lines: $(wc -l build-auralis.sh | cut -d' ' -f1)"
        
        # Check for key components
        if grep -q "Void Linux" build-auralis.sh; then
          echo "  âœ… Void Linux base system: CONFIRMED"
        else
          echo "  âš ï¸ Warning: Void Linux references not found"
        fi
        
        if grep -q -i "clear.*linux\|clear.*opt" build-auralis.sh; then
          echo "  âœ… Clear Linux optimizations: CONFIRMED"
        else
          echo "  âš ï¸ Warning: Clear Linux optimization references not found"
        fi
        
        if grep -q "CONFIG_NO_HZ_IDLE" build-auralis.sh; then
          echo "  âœ… CONFIG_NO_HZ_IDLE optimization: CONFIRMED"
        else
          echo "  âš ï¸ Warning: CONFIG_NO_HZ_IDLE not found"
        fi
        
    - name: ðŸ”¥ Build Auralis OS - Void Linux + Clear Linux Optimizations
      id: build
      run: |
        echo "ðŸ”¥ STARTING AURALIS OS BUILD!"
        echo "================================"
        echo "ðŸŽ¯ Void Linux + Clear Linux Optimizations"
        echo ""
        echo "ðŸŽ¯ Build Features:"
        echo "  ðŸ“¦ Base: Void Linux (XBPS package manager, runit init)"
        echo "  âš¡ Optimizations: Clear Linux inspired performance techniques"
        echo "  ðŸ”¥ Kernel: linux-zen + PREEMPT_RT + 2000 Hz + CONFIG_NO_HZ_IDLE"
        echo "  ðŸŒŸ Browser: Zen Browser with gorgeous aesthetics"
        echo "  ðŸ’» CPU Target: Intel optimized"
        echo "  ðŸ§  Strategy: Sequential resource management"
        echo ""
        echo "â° Expected timeline:"
        echo "  ðŸ“Š Phase 1 (Kernel): 45-90 minutes"
        echo "  ðŸ§¹ Phase 2 (Cleanup): 5 minutes"
        echo "  ðŸ—ï¸ Phase 3 (Void System): 15-30 minutes"
        echo ""
        echo "ðŸš€ Starting Void + Clear Linux optimized build..."
        
        # Set build environment variables
        export BUILD_START_TIME=$(date +%s)
        
        # Enable debug mode if requested
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "ðŸ› Debug mode enabled - verbose logging activated"
          set -x
        fi
        
        # Run the Void + Clear Linux optimized build
        if ./build-auralis.sh; then
          echo "build_success=true" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸŽ‰ AURALIS OS BUILD COMPLETED!"
          echo "ðŸŽ¯ Void Linux + Clear Linux optimizations successfully applied!"
          
          # Calculate build time
          BUILD_END_TIME=$(date +%s)
          BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
          BUILD_HOURS=$((BUILD_DURATION / 3600))
          BUILD_MINUTES=$(((BUILD_DURATION % 3600) / 60))
          
          echo "â±ï¸ Total build time: ${BUILD_HOURS}h ${BUILD_MINUTES}m"
          echo "build_duration=${BUILD_DURATION}" >> $GITHUB_OUTPUT
          
        else
          echo "build_success=false" >> $GITHUB_OUTPUT
          echo "âŒ Build failed - check logs for details"
          exit 1
        fi
        
    - name: ðŸ“Š Build Success Analysis
      if: steps.build.outputs.build_success == 'true'
      run: |
        echo "ðŸŽŠ BUILD SUCCESS ANALYSIS"
        echo "========================"
        echo "ðŸŽ¯ Void Linux + Clear Linux Optimizations Build"
        echo ""
        
        # Check output directory
        if [ -d "/tmp/auralis-output" ]; then
          echo "ðŸ“ Build output analysis:"
          ls -la /tmp/auralis-output/
          
          # Check for ISO file
          if ls /tmp/auralis-output/*.iso 1> /dev/null 2>&1; then
            ISO_FILE=$(ls /tmp/auralis-output/*.iso | head -1)
            echo "ðŸ’¿ ISO created successfully:"
            echo "  ðŸ“„ File: $(basename "$ISO_FILE")"
            echo "  ðŸ“ Size: $(du -h "$ISO_FILE" | cut -f1)"
            echo "  ðŸ“¦ Base: Void Linux"
            echo "  âš¡ Optimizations: Clear Linux techniques"
          else
            echo "âš ï¸ No ISO file found in output directory"
          fi
        else
          echo "âŒ Output directory not found"
        fi
        
        # Check ccache statistics
        echo ""
        echo "ðŸ”§ ccache statistics (Clear Linux optimization):"
        ccache -s | head -10 || echo "ccache stats unavailable"
        
        # Check system resources after build
        echo ""
        echo "ðŸ“Š Final system resources:"
        echo "  ðŸ§  RAM usage: $(free -h | grep '^Mem:')"
        echo "  ðŸ’¾ Disk usage: $(df -h / | tail -1)"
        
    - name: ðŸ“¦ Upload Auralis OS ISO (Void + Clear Linux)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: auralis-os-${{ env.AURALIS_VERSION }}-${{ github.run_number }}
        path: /tmp/auralis-output/
        retention-days: 30
        compression-level: 6
        
    - name: ðŸ“‹ Upload Build Logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build.log
          kernel-build.log
          /tmp/ccache.log
        retention-days: 14
        
    - name: ðŸ”§ Upload ccache Statistics
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ccache-stats-${{ github.run_number }}
        path: /tmp/ccache/
        retention-days: 7
        
    - name: ðŸŽ¯ Void + Clear Linux Build Summary
      if: always()
      run: |
        echo ""
        echo "ðŸŽŠ AURALIS OS BUILD SUMMARY"
        echo "============================"
        echo "ðŸŽ¯ Void Linux + Clear Linux Optimizations Edition"
        echo ""
        echo "ðŸ“‹ Build Information:"
        echo "  ðŸ·ï¸ Version: $AURALIS_VERSION ($AURALIS_CODENAME)"
        echo "  ðŸŽ® Build Type: $BUILD_TYPE"
        echo "  ðŸ“… Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "  ðŸ”„ Run Number: ${{ github.run_number }}"
        echo "  ðŸ’ª Runner: GitHub Actions (ubuntu-latest)"
        echo ""
        echo "ðŸŽ¯ System Architecture:"
        echo "  ðŸ“¦ Base System: Void Linux"
        echo "    ðŸ”§ Package Manager: XBPS"
        echo "    ðŸ”„ Init System: runit"
        echo "    ðŸ“š C Library: musl/glibc"
        echo "  âš¡ Performance Optimizations: Clear Linux inspired"
        echo "    ðŸ—ï¸ Compiler: Clang + LTO + -O3 -march=native"
        echo "    ðŸ’¾ Memory: CONFIG_NO_HZ_IDLE + power efficiency"
        echo "    ðŸ“Š Monitoring: PowerTOP, schedtool, cpupower"
        echo ""
        echo "ðŸ”¥ Gaming Features:"
        echo "  ðŸŽ® Custom Kernel: linux-zen + PREEMPT_RT + 2000 Hz"
        echo "  ðŸŒŸ Browser: Zen Browser (gorgeous aesthetics)"
        echo "  ðŸŽ¯ Gaming Stack: Steam, Lutris, GameMode, MangoHud"
        echo "  âš¡ Performance: zram, earlyoom, BBR, BFQ"
        echo "  ðŸ’» CPU Target: Intel optimized"
        echo "  ðŸªŸ Desktop: KDE Plasma gaming interface"
        echo ""
        echo "ðŸ”‘ Default Credentials:"
        echo "  ðŸ‘¤ Root: root / auralis"
        echo "  ðŸ‘¤ User: auralis / auralis"
        echo ""
        echo "ðŸš€ Key Commands:"
        echo "  ðŸ”¥ Activate Gaming Mode: sudo auralis-ultimate-gaming-mode"
        echo "  ðŸ“Š Power Analysis: sudo powertop"
        echo "  ðŸ“¦ Package Management: sudo xbps-install [package]"
        echo "  ðŸ”„ Service Management: sudo sv status [service]"
        echo ""
        
        # Build status
        if [ "${{ steps.build.outputs.build_success }}" = "true" ]; then
          echo "âœ… BUILD STATUS: SUCCESS"
          echo "ðŸ’¿ Auralis OS (Void + Clear Linux optimizations) ISO ready!"
          echo "ðŸ“¥ Download from Artifacts section above"
          
          if [ -n "${{ steps.build.outputs.build_duration }}" ]; then
            duration=${{ steps.build.outputs.build_duration }}
            hours=$((duration / 3600))
            minutes=$(((duration % 3600) / 60))
            echo "â±ï¸ Build completed in: ${hours}h ${minutes}m"
          fi
        else
          echo "âŒ BUILD STATUS: FAILED"
          echo "ðŸ“‹ Check build logs for details"
        fi
        
        echo ""
        echo "ðŸŒŒ Auralis OS - The Ultimate Gaming Linux Distribution! ðŸŒŒ"
        echo "ðŸ”¥ Void Linux Simplicity + Clear Linux Performance = PERFECTION! ðŸ”¥"
        echo "ðŸŽ¯ Best of Both Worlds: Lightweight Base + Optimized Performance! ðŸŽ¯"
        echo ""
        
    - name: ðŸ› Debug Information (Void + Clear Linux)
      if: failure() && env.DEBUG_MODE == 'true'
      run: |
        echo "ðŸ› DEBUG INFORMATION - VOID + CLEAR LINUX BUILD FAILURE"
        echo "======================================================="
        echo ""
        
        # System information
        echo "ðŸ–¥ï¸ System Information:"
        uname -a
        lscpu | head -20
        free -h
        df -h
        
        # Check for Void Linux specific issues
        echo ""
        echo "ðŸ“¦ Void Linux Build Check:"
        
        if [ -d "/tmp/auralis-build" ]; then
          echo "âœ… Build directory exists"
          ls -la /tmp/auralis-build/ | head -10
          
          if [ -d "/tmp/auralis-build/rootfs" ]; then
            echo "âœ… Void Linux rootfs extracted"
            ls -la /tmp/auralis-build/rootfs/ | head -5
          else
            echo "âŒ Void Linux rootfs not found"
          fi
        else
          echo "âŒ Build directory missing"
        fi
        
        # Check for XBPS tools
        if command -v xbps-install >/dev/null; then
          echo "âœ… XBPS tools available"
          xbps-install --version
        else
          echo "âŒ XBPS tools not available"
        fi
        
        # Check ccache
        if command -v ccache >/dev/null; then
          echo "âœ… ccache available (Clear Linux optimization)"
          ccache -s
        else
          echo "âŒ ccache not available"
        fi
        
        # Check disk space issues
        echo ""
        echo "ðŸ’¾ Disk Space Analysis:"
        df -h
        du -sh /tmp/* 2>/dev/null | sort -hr | head -10 || true
        
        # Memory analysis
        echo ""
        echo "ðŸ§  Memory Analysis:"
        free -h
        cat /proc/meminfo | head -10
        
    - name: ðŸ§¹ Cleanup Build Environment
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up Void + Clear Linux build environment..."
        
        # Clean build directories
        sudo rm -rf /tmp/auralis-build /tmp/auralis-kernel-artifacts 2>/dev/null || true
        
        # Clean ccache
        ccache -C 2>/dev/null || true
        
        # Show final disk usage
        echo "ðŸ“Š Final disk usage:"
        df -h /
        
        echo "âœ… Build environment cleanup completed!"
        echo "ðŸŽ¯ Void Linux + Clear Linux optimized build process finished!"
